'use server';

import * as cheerio from 'cheerio';
import { google } from 'googleapis';

if (!process.env.GOOGLE_SEARCH_API_KEY || !process.env.GOOGLE_SEARCH_CX) {
    throw new Error('Missing required environment variables: GOOGLE_SEARCH_API_KEY and/or GOOGLE_SEARCH_CX');
}

const getSearchResults = async (query: string) => {
    let links = [] as string[];

    try {
        const customsearch = google.customsearch('v1');
        
        const res = await customsearch.cse.list({
            cx: process.env.GOOGLE_SEARCH_CX,
            q: query,
            auth: process.env.GOOGLE_SEARCH_API_KEY,
        });

        const data = res.data;

        links = (data.items || [])
            .map((item) => item.link || '')
            .filter((link: string) => !link.endsWith('.pdf')).slice(0, 3);

        console.log('Links:', links);
    } catch (error) {
        console.error('Error fetching search results:', error);
    }

    return links;

    // const resTxt = `{"kind":"customsearch#search","url":{"type":"application/json","template":"https://www.googleapis.com/customsearch/v1?q={searchTerms}&num={count?}&start={startIndex?}&lr={language?}&safe={safe?}&cx={cx?}&sort={sort?}&filter={filter?}&gl={gl?}&cr={cr?}&googlehost={googleHost?}&c2coff={disableCnTwTranslation?}&hq={hq?}&hl={hl?}&siteSearch={siteSearch?}&siteSearchFilter={siteSearchFilter?}&exactTerms={exactTerms?}&excludeTerms={excludeTerms?}&linkSite={linkSite?}&orTerms={orTerms?}&dateRestrict={dateRestrict?}&lowRange={lowRange?}&highRange={highRange?}&searchType={searchType}&fileType={fileType?}&rights={rights?}&imgSize={imgSize?}&imgType={imgType?}&imgColorType={imgColorType?}&imgDominantColor={imgDominantColor?}&alt=json"},"queries":{"request":[{"title":"Google Custom Search - financial statement for company krka.biz in year 2023","totalResults":"126000","searchTerms":"financial statement for company krka.biz in year 2023","count":10,"startIndex":1,"inputEncoding":"utf8","outputEncoding":"utf8","safe":"off","cx":"4567d9c7763d346b2"}],"nextPage":[{"title":"Google Custom Search - financial statement for company krka.biz in year 2023","totalResults":"126000","searchTerms":"financial statement for company krka.biz in year 2023","count":10,"startIndex":11,"inputEncoding":"utf8","outputEncoding":"utf8","safe":"off","cx":"4567d9c7763d346b2"}]},"context":{"title":"text_copmany"},"searchInformation":{"searchTime":0.462041,"formattedSearchTime":"0.46","totalResults":"126000","formattedTotalResults":"126,000"},"items":[{"kind":"customsearch#result","title":"Financial reports | Krka","htmlTitle":"<b>Financial reports</b> | <b>Krka</b>","link":"https://www.krka.biz/investors/financial-reports/","displayLink":"www.krka.biz","snippet":"6 days ago ... Browse through our annual and interim business reports to learn more about Krka's success. 2023 ANNUAL REPORT.","htmlSnippet":"6 days ago <b>...</b> Browse through our annual and interim <b>business</b> reports to learn more about <b>Krka&#39;s</b> success. <b>2023 ANNUAL REPORT</b>.","formattedUrl":"https://www.krka.biz/investors/financial-reports/","htmlFormattedUrl":"https://www.<b>krka.biz</b>/investors/<b>financial</b>-reports/","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS6rx_5XbuNkmDwFdqPUGCPYVxQq0_4bw27OZM8jtCN8vJ8pSBCW0o-rpAb&s","width":"300","height":"168"}],"metatags":[{"msapplication-tilecolor":"#006B32","og:image":"https://www.krka.biz/_assets/V12SI-vlagatelji-financna-porocila-Krka-investitorji-adstock-H2-c1640x920-M21.jpg","theme-color":"#ffffff","og:type":"article","og:image:width":"1640","twitter:card":"summary_large_image","og:site_name":"Krka","og:title":"Financial reports - Krka","og:image:height":"920","twitter:label2":"Est. reading time","og:description":"Krka’s annual and interim business reports.","twitter:data2":"0 minutes","viewport":"width=device-width,initial-scale=1","og:locale":"sl_SI","og:url":"https://www.krka.biz/investors/financial-reports/"}],"cse_image":[{"src":"https://www.krka.biz/_assets/V12SI-vlagatelji-financna-porocila-Krka-investitorji-adstock-H2-c1640x920-M21.jpg"}]}},{"kind":"customsearch#result","title":"Krka Annual Report 2022","htmlTitle":"<b>Krka Annual Report</b> 2022","link":"https://webapi.krka.biz/media/doc/en/for_investors/2023/Annual%20Report%202022.pdf","displayLink":"webapi.krka.biz","snippet":"Dec 31, 2022 ... Dear shareholders, business partners and employees,. The Krka Group achieved good results in 2022 despite constant changes and swift reversals ...","htmlSnippet":"Dec 31, 2022 <b>...</b> Dear shareholders, <b>business</b> partners and employees,. The <b>Krka</b> Group achieved good <b>results</b> in 2022 despite constant changes and swift reversals&nbsp;...","formattedUrl":"https://webapi.krka.biz/media/doc/.../2023/Annual%20Report%202022.pdf","htmlFormattedUrl":"https://webapi.<b>krka.biz</b>/media/doc/.../<b>2023</b>/Annual%20Report%202022.pdf","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQfCZsQNiKpsrcKhzhBK-mfyh6QyAj2uI7jSZN07vZmYAlt-xVkMrH9Db4&s","width":"196","height":"257"}],"metatags":[{"moddate":"D:20230404092852+02'00'","creator":"Microsoft® Word 2016","creationdate":"D:20230404092852+02'00'","author":"novakovic;redek","producer":"Microsoft® Word 2016","title":"Krka Annual Report 2022"}],"cse_image":[{"src":"x-raw-image:///e87f6c0e7553d60ec3714f3f3f97a5a7ec4186524f3c91563c2e1a137d3ff4a0"}]},"mime":"application/pdf","fileFormat":"PDF/Adobe Acrobat"},{"kind":"customsearch#result","title":"Unaudited interim report of the Krka Group and Krka, d. d., Novo ...","htmlTitle":"Unaudited interim <b>report</b> of the <b>Krka</b> Group and <b>Krka</b>, d. d., Novo ...","link":"https://www.krka.biz/_assets/Unaudited-Interim-report-of-the-Krka-Group-and-Krka-d.-d.-Novo-mesto-for-the-nine-months-ended-30-September-2024.pdf","displayLink":"www.krka.biz","snippet":"Sep 30, 2024 ... and January–September 2023 are unaudited, while financial statements for the full 2023 financial year are audited. Krka, d. d., Novo mesto ...","htmlSnippet":"Sep 30, 2024 <b>...</b> and January–September <b>2023</b> are unaudited, while <b>financial statements</b> for the full <b>2023</b> financial <b>year</b> are audited. <b>Krka</b>, d. d., Novo mesto&nbsp;...","formattedUrl":"https://www.krka.biz/_.../Unaudited-Interim-report-of-the-Krka-Group-and...","htmlFormattedUrl":"https://www.<b>krka.biz</b>/_.../Unaudited-Interim-report-of-the-Krka-Group-and...","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3cS1OfXLQjY3aGll7R_aUdiBQdLWkRdyP3MptY51fBKst3IcSMqQa0Gg&s","width":"189","height":"267"}],"metatags":[{"moddate":"D:20241114075303+01'00'","creator":"Microsoft® Word LTSC","creationdate":"D:20241114075303+01'00'","author":"Aljoša","producer":"Microsoft® Word LTSC","title":"Unaudited interim report of the Krka Group and Krka, d. d., Novo mesto for the nine months ended 30 September 2024"}],"cse_image":[{"src":"x-raw-image:///dccd6759dbde363af237289fed8c680a8b16ccee1ccc66b30439a714179fb276"}]},"mime":"application/pdf","fileFormat":"PDF/Adobe Acrobat"},{"kind":"customsearch#result","title":"Krka Releases 2022 Unaudited Financial Statements","htmlTitle":"<b>Krka</b> Releases 2022 Unaudited <b>Financial Statements</b>","link":"https://webapi.krka.biz/media/doc/en/for_investors/2023/Press-Release-unaudited-financial-statements.pdf","displayLink":"webapi.krka.biz","snippet":"Novo mesto, 16 March 2023 – Krka released the 2022 unaudited financial statements of the Krka Group and the controlling company Krka, d. d., ...","htmlSnippet":"Novo mesto, 16 March <b>2023</b> – <b>Krka</b> released the 2022 unaudited <b>financial statements of</b> the <b>Krka</b> Group and the controlling <b>company Krka</b>, d. d.,&nbsp;...","formattedUrl":"https://webapi.krka.biz/.../2023/Press-Release-unaudited-financial-statement...","htmlFormattedUrl":"https://webapi.<b>krka.biz</b>/.../<b>2023</b>/Press-Release-unaudited-<b>financial</b>-<b>statement</b>...","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSqZ5qDya3QJsKHb2AYh5ZZbtFpuEnlTukZxgdbEWxyhNfbOjD4Zgm0Ccbf&s","width":"276","height":"182"}],"metatags":[{"moddate":"D:20230316071952+01'00'","creator":"Microsoft® Word 2016","creationdate":"D:20230316071952+01'00'","author":"Master","producer":"Microsoft® Word 2016"}],"cse_image":[{"src":"x-raw-image:///b1fdcd90373de26bab6698dd473fdeeed53d3e0cf4f41074ceecd04feef0e510"}]},"mime":"application/pdf","fileFormat":"PDF/Adobe Acrobat"},{"kind":"customsearch#result","title":"Krka Releases 2023 Unaudited Financial Statements | Krka","htmlTitle":"<b>Krka</b> Releases <b>2023</b> Unaudited <b>Financial Statements</b> | <b>Krka</b>","link":"https://www.krka.biz/media-center/news/krka-releases-2023-unaudited-financial-statements/","displayLink":"www.krka.biz","snippet":"Despite all demanding challenges, we continued our long-term stable business and sustainable growth. Over 100 million people in more than 70 countries around ...","htmlSnippet":"Despite all demanding challenges, we continued our long-term stable <b>business</b> and sustainable growth. Over 100 million people in more than 70 countries around&nbsp;...","formattedUrl":"https://www.krka.biz/.../krka-releases-2023-unaudited-financial-statements/","htmlFormattedUrl":"https://www.<b>krka.biz</b>/.../krka-releases-<b>2023</b>-unaudited-<b>financial</b>-<b>statement</b>s/","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTvGq6L0FBqbb2Uf9MPN5weRJLGqc94AQ1QkWXbP8_39p827pusnzKB8vGc&s","width":"275","height":"183"}],"metatags":[{"msapplication-tilecolor":"#006B32","og:image":"https://www.krka.biz/_assets/Krka-rezultati-2023-w825.jpg","theme-color":"#ffffff","og:type":"article","og:image:width":"825","twitter:card":"summary_large_image","og:site_name":"Krka","og:title":"Krka Releases 2023 Unaudited Financial Statements - Krka","og:image:height":"550","twitter:label2":"Est. reading time","og:description":"Krka released the 2023 unaudited financial statements of the Krka Group and the controlling company Krka, d. d., Novo mesto today. The report was published on the Ljubljana Stock Exchange website after being discussed by the Company’s Supervisory Board at their meeting yesterday. The Krka Group generated €1,806.4 million in revenue last year, up €88.9 million or 5% on 2022.","twitter:data2":"2 minutes","viewport":"width=device-width,initial-scale=1","og:locale":"sl_SI","og:url":"https://www.krka.biz/media-center/news/krka-releases-2023-unaudited-financial-statements/"}],"cse_image":[{"src":"https://www.krka.biz/_assets/Krka-rezultati-2023-w825.jpg"}]}},{"kind":"customsearch#result","title":"2019 Annual Report","htmlTitle":"2019 <b>Annual Report</b>","link":"https://webapi.krka.biz/media/doc/en/for_investors/2020/KRKA_2019%20Annual%20Report%20digital.pdf","displayLink":"webapi.krka.biz","snippet":"... Krka Group business operations were profitable. Page 3. Exceptional Year for Krka ... Krka 2019 Annual Report. 1. Krka is an innovative generic company that ...","htmlSnippet":"... <b>Krka</b> Group <b>business</b> operations were profitable. Page 3. Exceptional <b>Year</b> for <b>Krka</b> ... <b>Krka</b> 2019 <b>Annual Report</b>. 1. <b>Krka</b> is an innovative generic <b>company</b> that&nbsp;...","formattedUrl":"https://webapi.krka.biz/.../KRKA_2019%20Annual%20Report%20digital.p...","htmlFormattedUrl":"https://webapi.<b>krka.biz</b>/.../KRKA_2019%20Annual%20Report%20digital.p...","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSRXEwxO8fj3Q1_kxAsk4-fu8-gsS1Pq2xdI7JPRWvwumT7U1JQxq_luqgO&s","width":"254","height":"198"}],"metatags":[{"moddate":"D:20200610160912+02'00'","creationdate":"D:20200608160352+02'00'","creator":"Adobe InDesign CS4 (6.0)","producer":"Adobe PDF Library 9.0"}],"cse_image":[{"src":"x-raw-image:///4eac2e3b6774a57380cae47cd515948a9dee102c50b1ce1948ba1772775ab4f3"}]},"mime":"application/pdf","fileFormat":"PDF/Adobe Acrobat"},{"kind":"customsearch#result","title":"Unaudited Interim Financial Report of the Krka Group and Krka, dd ...","htmlTitle":"Unaudited Interim <b>Financial Report</b> of the <b>Krka</b> Group and <b>Krka</b>, dd ...","link":"https://www.krka.biz/_assets/Unaudited-Interim-Financial-Report-of-the-Krka-Group-and-Krka-Company-for-1H-2024.pdf","displayLink":"www.krka.biz","snippet":"Jul 17, 2024 ... half of 2023 are unaudited, while financial statements for the full financial year 2023 are audited. ... companies in Slovenia (end of 2023 ...","htmlSnippet":"Jul 17, 2024 <b>...</b> half of <b>2023</b> are unaudited, while <b>financial statements</b> for the full financial <b>year 2023</b> are audited. ... <b>companies</b> in Slovenia (end of <b>2023</b>&nbsp;...","formattedUrl":"https://www.krka.biz/_.../Unaudited-Interim-Financial-Report-of-the-Krka-...","htmlFormattedUrl":"https://www.<b>krka.biz</b>/_.../Unaudited-Interim-<b>Financial</b>-Report-of-the-Krka-...","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3cS1OfXLQjY3aGll7R_aUdiBQdLWkRdyP3MptY51fBKst3IcSMqQa0Gg&s","width":"189","height":"267"}],"metatags":[{"moddate":"D:20240718064732+02'00'","creator":"Microsoft® Word LTSC","creationdate":"D:20240718064732+02'00'","author":"Aljoša","producer":"Microsoft® Word LTSC","title":"Nerevidirano poročilo o poslovanju"}],"cse_image":[{"src":"x-raw-image:///dccd6759dbde363af237289fed8c680a8b16ccee1ccc66b30439a714179fb276"}]},"mime":"application/pdf","fileFormat":"PDF/Adobe Acrobat"},{"kind":"customsearch#result","title":"Krka Receives TOP Education Management Certificate for ...","htmlTitle":"<b>Krka</b> Receives TOP Education Management Certificate for ...","link":"https://news.europawire.eu/krka-receives-top-education-management-certificate-for-investment-in-employee-development/eu-press-release/2023/11/30/11/28/37/125992/","displayLink":"news.europawire.eu","snippet":"Nov 30, 2023 ... announces the availability of the report on corporate income tax information for the financial year ending December 31, 2023 · Unlocking the ...","htmlSnippet":"Nov 30, 2023 <b>...</b> announces the availability of the <b>report</b> on <b>corporate income</b> tax information for the <b>financial year</b> ending December 31, <b>2023</b> &middot; Unlocking the&nbsp;...","formattedUrl":"https://news.europawire.eu/krka-receives-top...in.../2023/.../125992/","htmlFormattedUrl":"https://news.europawire.eu/krka-receives-top...in.../<b>2023</b>/.../125992/","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRexQXxjgKG2z7C4CFW9FR32RMyvi_gPpHymzvy3Dlk0ptwHwzpozWgTyk&s","width":"225","height":"225"}],"metatags":[{"cdp-version":"1.4.9","og:image":"https://news.europawire.eu/wp-content/uploads/2015/11/logo_250x250.png","og:type":"article","theme-color":"#000000","og:site_name":"EuropaWire","apple-mobile-web-app-title":"EuropaWire","og:title":"Krka Receives TOP Education Management Certificate for Investment in Employee Development","og:description":"(IN BRIEF) Krka, a Slovenian pharmaceutical company, has been honored with the TOP Education Management certificate at the Edutainment 2023 convention. This","fb:app_id":"149517881860345","viewport":"initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, width=device-width","google-adsense-platform-domain":"sitekit.withgoogle.com","og:locale":"en_us","google-adsense-platform-account":"ca-host-pub-2644536267352236","fb:admins":"523749541","og:url":"https://news.europawire.eu/krka-receives-top-education-management-certificate-for-investment-in-employee-development/eu-press-release/2023/11/30/11/28/37/125992/"}],"cse_image":[{"src":"https://news.europawire.eu/wp-content/uploads/2015/11/logo_250x250.png"}]}},{"kind":"customsearch#result","title":"Financial reports | Krka","htmlTitle":"<b>Financial reports</b> | <b>Krka</b>","link":"https://www.krka.ru/investors/financial-reports/","displayLink":"www.krka.ru","snippet":"Browse through our annual and interim business reports to learn more about Krka's success. 2022 ANNUAL REPORT. 2022 Annual Report2022 Annual Report (ESEF) ...","htmlSnippet":"Browse through our annual and interim <b>business</b> reports to learn more about Krka&#39;s success. 2022 <b>ANNUAL REPORT</b>. 2022 <b>Annual Report</b>2022 <b>Annual Report</b> (ESEF)&nbsp;...","formattedUrl":"https://www.krka.ru/investors/financial-reports/","htmlFormattedUrl":"https://www.krka.ru/investors/<b>financial</b>-reports/","pagemap":{"cse_thumbnail":[{"src":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRDwPC9_hAKhaliIFRFEvoCDr9sR85cYk_GnrTSe01yob9qbT-E5IFY42YF&s","width":"300","height":"168"}],"metatags":[{"msapplication-tilecolor":"#006B32","og:image":"https://www.krka.ru/_assets/V12SI-vlagatelji-financna-porocila-Krka-investitorji-adstock-H2-c1640x920-M21.jpg","theme-color":"#ffffff","og:type":"article","og:image:width":"1640","twitter:card":"summary_large_image","og:site_name":"Krka","og:title":"Financial reports - Krka","og:image:height":"920","twitter:label2":"Est. reading time","og:description":"Krka’s annual and interim business reports.","twitter:data2":"0 minutes","viewport":"width=device-width,initial-scale=1","og:locale":"sl_SI","og:url":"https://www.krka.ru/investors/financial-reports/"}],"cse_image":[{"src":"https://www.krka.ru/_assets/V12SI-vlagatelji-financna-porocila-Krka-investitorji-adstock-H2-c1640x920-M21.jpg"}]}},{"kind":"customsearch#result","title":"Krka Group Q1 2024 Business Performance Results Webcast","htmlTitle":"<b>Krka</b> Group Q1 2024 <b>Business</b> Performance <b>Results</b> Webcast","link":"https://www.krka.ua/_assets/Krka-Group-Q1-2024-Results-Webcast-Transcript.pdf","displayLink":"www.krka.ua","snippet":"May 16, 2024 ... Brane Kastelec, Finance. Director. Krka once again delivered robust top line growth and operating profitability. Detailed interpretation of our ...","htmlSnippet":"May 16, 2024 <b>...</b> Brane Kastelec, <b>Finance</b>. Director. <b>Krka</b> once again delivered robust top line growth and operating profitability. Detailed interpretation of our&nbsp;...","formattedUrl":"https://www.krka.ua/_.../Krka-Group-Q1-2024-Results-Webcast-Transcript....","htmlFormattedUrl":"https://www.krka.ua/_.../Krka-Group-Q1-2024-Results-Webcast-Transcript....","pagemap":{"metatags":[{"moddate":"D:20240521080910+02'00'","creator":"Microsoft® Word LTSC","creationdate":"D:20240521080910+02'00'","author":"Ožbolt, Uroš","producer":"Microsoft® Word LTSC"}]},"mime":"application/pdf","fileFormat":"PDF/Adobe Acrobat"}]}`

    // const data = JSON.parse(resTxt);

    // links = data.items 
    //     .map((item: { link: string }) => item.link)
    //     .filter((link: string) => !link.endsWith('.pdf')).slice(0, 3);;


    // console.log('Links:', links);

    // return links;
}

const getTextForUrl = async (url: string) => {
    let text = '';

    try {
        const response = await fetch(url);
        const resp = await response.text();
        const $ = cheerio.load(resp);

        // Extract text from the entire body and remove new lines and extra spaces
        text = $('body').text().replace(/^\s*[\r\n]/gm, '').trim();
    } catch (error) {
        console.error('Error fetching website:', error);
    }

    return text;
}

export const getContentForComany = async (company: string) => {
    const links = await getSearchResults(`financial statement for company ${company} in year 2023`)

    const relevantContent = [];

    for (const link of links) {
        const text = await getTextForUrl(link as string);
        relevantContent.push(text);
    }

    return relevantContent;
}